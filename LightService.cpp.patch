--- LightService.cpp.orig	2016-12-05 19:58:18.545072973 -0600
+++ LightService.cpp	2016-12-05 20:03:40.801067895 -0600
@@ -16,7 +16,7 @@
 // The username of the client (currently we authorize all clients simulating a pressed button on the bridge)
 String client;
 
-ESP8266WebServer HTTP(80);
+ESP8266WebServer * httpServer;
 
 LightServiceClass LightService;
 
@@ -113,7 +113,7 @@
   }
 }
 
-void LightServiceClass::begin() {
+void LightServiceClass::begin(ESP8266WebServer * svr) {
   macString = String(WiFi.macAddress());
   bridgeIDString = macString;
   bridgeIDString.replace(":", "");
@@ -122,14 +122,11 @@
   netmaskString = StringIPaddress(WiFi.subnetMask());
   gatewayString = StringIPaddress(WiFi.gatewayIP());
 
-  Serial.print("Starting HTTP at ");
-  Serial.print(WiFi.localIP());
-  Serial.print(":");
-  Serial.println(80);
+  Serial.println("Setting up HTTP");
 
-  HTTP.onNotFound(handleAllOthers);
+  httpServer = svr;
 
-  HTTP.begin();
+  httpServer->onNotFound(handleAllOthers);
 
   Serial.println("Starting SSDP...");
   SSDP.begin();
@@ -149,7 +146,7 @@
 }
 
 void LightServiceClass::update() {
-  HTTP.handleClient();
+  httpServer->handleClient();
 }
 
 void sendJson(aJsonObject *root)
@@ -160,7 +157,7 @@
   aJson.deleteItem(root);
   Serial.println(millis());
   Serial.println(msgStr);
-  HTTP.send(200, "text/plain", msgStr);
+  httpServer->send(200, "text/plain", msgStr);
   free(msgStr);
 }
 
@@ -258,7 +255,7 @@
 }
 
 void sendUpdated() {
-  HTTP.send(200, "text/plain", "Updated.");
+  httpServer->send(200, "text/plain", "Updated.");
 }
 
 bool parseHueLightInfo(HueLightInfo currentInfo, aJsonObject *parsedRoot, HueLightInfo *newInfo) {
@@ -413,7 +410,7 @@
 void lightsHandler(String user, String uri) {
   uri = trimSlash(uri.substring(6));
   if (uri == "") {
-    switch (HTTP.method()) {
+    switch (httpServer->method()) {
       case HTTP_GET: {
           // dump existing lights
           aJsonObject *lights = aJson.createObject();
@@ -443,8 +440,8 @@
     int numberOfTheLight = atoi(lightText.c_str()) - 1;
 
     Serial.print("JSON Body:");
-    Serial.println(HTTP.arg("plain"));
-    aJsonObject* parsedRoot = aJson.parse(( char*) HTTP.arg("plain").c_str());
+    Serial.println(httpServer->arg("plain"));
+    aJsonObject* parsedRoot = aJson.parse(( char*) httpServer->arg("plain").c_str());
     LightHandler *handler = LightService.getLightHandler(numberOfTheLight);
     if (!handler) {
       sendError(3, uri, "Requested light not available");
@@ -459,7 +456,7 @@
       }
       handler->handleQuery(numberOfTheLight, newInfo, parsedRoot);
       aJson.deleteItem(parsedRoot);
-    } else if (HTTP.arg("plain") != "") {
+    } else if (httpServer->arg("plain") != "") {
       // unparseable json
       sendError(2, "groups/0/action", "Bad JSON body in request");
       return;
@@ -484,8 +481,8 @@
 
 void applyConfigToLightMask(unsigned int lights) {
   Serial.print("JSON Body:");
-  Serial.println(HTTP.arg("plain"));
-  aJsonObject* parsedRoot = aJson.parse(( char*) HTTP.arg("plain").c_str());
+  Serial.println(httpServer->arg("plain"));
+  aJsonObject* parsedRoot = aJson.parse(( char*) httpServer->arg("plain").c_str());
   if (parsedRoot) {
     for (int i = 0; i < LightService.getLightsAvailable(); i++) {
       LightHandler *handler = LightService.getLightHandler(i);
@@ -499,7 +496,7 @@
 
     // As per the spec, the response can be "Updated." for memory-constrained devices
     sendUpdated();
-  } else if (HTTP.arg("plain") != "") {
+  } else if (httpServer->arg("plain") != "") {
     // unparseable json
     sendError(2, "groups/0/action", "Bad JSON body in request");
   }
@@ -612,7 +609,7 @@
     sendError(301, "groups", "Groups table full");
     return;
   }
-  if (!updateGroupSlot(availableSlot, HTTP.arg("plain"))) {
+  if (!updateGroupSlot(availableSlot, httpServer->arg("plain"))) {
     String slot = "";
     slot += (availableSlot + 1);
     sendSuccess("id", slot);
@@ -639,7 +636,7 @@
 void groupsHandler(String user, String uri) {
   uri = trimSlash(uri.substring(6));
   if (uri == "") {
-    switch (HTTP.method()) {
+    switch (httpServer->method()) {
       case HTTP_GET:
         groupListingHandler();
         break;
@@ -675,7 +672,7 @@
   }
 
   if (uri == "") {
-    switch (HTTP.method()) {
+    switch (httpServer->method()) {
       case HTTP_GET:
         if (groupNum != -1) {
           sendJson(lightGroups[groupNum]->getJson());
@@ -698,7 +695,7 @@
         break;
       case HTTP_PUT:
         // validate body, delete old group, create new group
-        updateGroupSlot(groupNum, HTTP.arg("plain"));
+        updateGroupSlot(groupNum, httpServer->arg("plain"));
         sendUpdated();
         break;
       case HTTP_DELETE: {
@@ -717,7 +714,7 @@
   }
 
   if (uri == "action") {
-    if (HTTP.method() != HTTP_PUT) {
+    if (httpServer->method() != HTTP_PUT) {
       // error, only PUT allowed
       sendError(4, "/api/" + user + "/groups/" + groupNum + "/action", "Only PUT supported for groups/*/action");
       return;
@@ -784,7 +781,7 @@
     return;
   }
   // updateSceneSlot sends failure messages
-  if (!updateSceneSlot(sceneIndex, id, HTTP.arg("plain"))) {
+  if (!updateSceneSlot(sceneIndex, id, httpServer->arg("plain"))) {
     if (id == "") {
       id = String(sceneIndex);
     }
@@ -824,7 +821,7 @@
 void scenesHandler(String user, String uri) {
   uri = trimSlash(uri.substring(6));
   if (uri == "") {
-    switch (HTTP.method()) {
+    switch (httpServer->method()) {
       case HTTP_GET:
         sceneListingHandler();
         break;
@@ -850,7 +847,7 @@
   LightGroup *scene = findScene(sceneId);
 
   if (uri == "") {
-    switch (HTTP.method()) {
+    switch (httpServer->method()) {
       case HTTP_GET:
         if (scene) {
           sendJson(scene->getSceneJson());
@@ -889,7 +886,7 @@
 
   if (uri.startsWith("lightstates/") || uri.startsWith("lights/")) {
     uri = uri.substring(12);
-    if (HTTP.method() != HTTP_POST && HTTP.method() != HTTP_PUT) {
+    if (httpServer->method() != HTTP_POST && httpServer->method() != HTTP_PUT) {
       // error, only POST allowed
       sendError(4, "/api/" + user + "/scenes/" + sceneId + "/lightstates", "Only PUT and POST supported for scenes/*/light*");
       return;
@@ -923,9 +920,9 @@
 }
 
 void descriptionHandler(String user, String uri) {
-  WiFiClient client = HTTP.client();
+  WiFiClient client = httpServer->client();
   String str = "<root><specVersion><major>1</major><minor>0</minor></specVersion><URLBase>http://" + ipString + ":80/</URLBase><device><deviceType>urn:schemas-upnp-org:device:Basic:1</deviceType><friendlyName>Philips hue (" + ipString + ")</friendlyName><manufacturer>Royal Philips Electronics</manufacturer><manufacturerURL>http://www.philips.com</manufacturerURL><modelDescription>Philips hue Personal Wireless Lighting</modelDescription><modelName>Philips hue bridge 2012</modelName><modelNumber>929000226503</modelNumber><modelURL>http://www.meethue.com</modelURL><serialNumber>00178817122c</serialNumber><UDN>uuid:2f402f80-da50-11e1-9b23-00178817122c</UDN><presentationURL>index.html</presentationURL><iconList><icon><mimetype>image/png</mimetype><height>48</height><width>48</width><depth>24</depth><url>hue_logo_0.png</url></icon><icon><mimetype>image/png</mimetype><height>120</height><width>120</width><depth>24</depth><url>hue_logo_3.png</url></icon></iconList></device></root>";
-  HTTP.send(200, "text/plain", str);
+  httpServer->send(200, "text/plain", str);
   Serial.println(str);
 }
 
@@ -945,8 +942,8 @@
   Serial.print("=== ");
   Serial.println(millis());
   Serial.print("Method: ");
-  Serial.println(methodToString(HTTP.method()));
-  String fullUri = trimSlash(HTTP.uri());
+  Serial.println(methodToString(httpServer->method()));
+  String fullUri = trimSlash(httpServer->uri());
   Serial.print("requestedUri: ");
   Serial.println(fullUri);
 
@@ -959,7 +956,7 @@
   // make sure /api is there, rip it off along with trailing slash if present
   if (!fullUri.startsWith("api")) {
     // bail, unimplemented
-    HTTP.send(200, "text/plain", "{}");
+    httpServer->send(200, "text/plain", "{}");
     Serial.println("FIXME: To be implemented");
     return;
   }
@@ -998,17 +995,17 @@
   } else if (requestedUri.startsWith("scenes")) {
     scenesHandler(user, requestedUri);
   } else if (requestedUri.startsWith("sensors")) {
-    HTTP.send(200, "text/plain", "{}");
+    httpServer->send(200, "text/plain", "{}");
   } else if (requestedUri.startsWith("sechedules")) {
-    HTTP.send(200, "text/plain", "{}");
+    httpServer->send(200, "text/plain", "{}");
   } else if (requestedUri.startsWith("rules")) {
-    HTTP.send(200, "text/plain", "{}");
+    httpServer->send(200, "text/plain", "{}");
   } else {
-    HTTP.send(200, "text/plain", "()");
+    httpServer->send(200, "text/plain", "()");
     Serial.println("FIXME: To be implemented");
 
     // Print what the client has POSTed
-    for (uint8_t i = 0; i < HTTP.args(); i++) Serial.printf("ARG[%u]: %s=%s\n", i, HTTP.argName(i).c_str(), HTTP.arg(i).c_str());
+    for (uint8_t i = 0; i < httpServer->args(); i++) Serial.printf("ARG[%u]: %s=%s\n", i, httpServer->argName(i).c_str(), httpServer->arg(i).c_str());
   }
   Serial.println(millis());
 }
